import yaml
import json
from elasticsearch import Elasticsearch
from typing import Dict, Any

class IntentManager:
    def __init__(self, es_host: str, es_port: int):
        """Initialize the Elasticsearch client."""
        self.es = Elasticsearch([{'host': es_host, 'port': es_port}])
        self.index = 'intents_index'  # Name of the index to store intents data

    def escape_fields(self, intent_body: Dict[str, Any]) -> Dict[str, Any]:
        """
        Dynamically escape fields in the intent body, specifically 'query', 'response', 
        and 'follow_ups' if they exist.
        """
        # Check if 'queries' exists in the intent body
        queries = intent_body.get('queries', {})
        
        # Escape for each query type dynamically if 'query' exists
        for query_name, query_content in queries.items():
            if 'query' in query_content:
                query_content['query'] = json.dumps(query_content['query'])[1:-1]  # Escape special chars

        # Escape 'response' field if it exists
        if 'response' in intent_body:
            intent_body['response'] = json.dumps(intent_body['response'])[1:-1]

        # Escape 'follow_ups' field if it exists
        if 'follow_ups' in intent_body:
            intent_body['follow_ups'] = json.dumps(intent_body['follow_ups'])[1:-1]

        intent_body['queries'] = queries
        return intent_body

    def unescape_fields(self, intent_body: Dict[str, Any]) -> Dict[str, Any]:
        """
        Dynamically unescape fields in the intent body, specifically 'query', 'response',
        and 'follow_ups' if they exist.
        """
        queries = intent_body.get('queries', {})

        # Unescape the 'query' field for each query type
        for query_name, query_content in queries.items():
            if 'query' in query_content:
                query_content['query'] = json.loads(f'"{query_content["query"]}"')

        # Unescape 'response' field if it exists
        if 'response' in intent_body:
            intent_body['response'] = json.loads(f'"{intent_body["response"]}"')

        # Unescape 'follow_ups' field if it exists
        if 'follow_ups' in intent_body:
            intent_body['follow_ups'] = json.loads(f'"{intent_body["follow_ups"]}"')

        intent_body['queries'] = queries
        return intent_body

    def store_intent_to_elastic(self, intent_data: Dict[str, Any]):
        """
        Store intent data to Elasticsearch. Assumes the intent_name is present as the key for the document ID.
        """
        for intent_name, intent_body in intent_data.get('intents', {}).items():
            # Escape relevant fields
            escaped_intent_body = self.escape_fields(intent_body)
            
            # Store each intent under its own document ID (intent_name)
            self.es.index(index=self.index, id=intent_name, body=escaped_intent_body)
            print(f"Stored intent: {intent_name} to Elasticsearch.")

    def retrieve_intents_from_elastic(self) -> Dict[str, Any]:
        """
        Retrieve all intents from Elasticsearch and format them in the YAML structure.
        Returns the intents as a dictionary in the correct structure.
        """
        body = {"query": {"match_all": {}}}
        res = self.es.search(index=self.index, body=body, size=1000)  # Retrieve all entries
        intents_data = {'intents': {}}
        
        for hit in res['hits']['hits']:
            intent_name = hit['_id']
            # Unescape relevant fields when retrieving
            intent_body = hit['_source']
            intent_body = self.unescape_fields(intent_body)
            intents_data['intents'][intent_name] = intent_body
        
        return intents_data

    def save_yaml(self, data: Dict[str, Any], file_path: str):
        """Save the dictionary to a YAML file."""
        with open(file_path, 'w') as yaml_file:
            yaml.dump(data, yaml_file, default_flow_style=False, sort_keys=False)
        print(f"YAML file saved to {file_path}")

    def load_yaml(self, file_path: str) -> Dict[str, Any]:
        """Load data from a YAML file."""
        with open(file_path, 'r') as yaml_file:
            return yaml.safe_load(yaml_file)

    def convert_elastic_to_yaml(self, file_path: str):
        """Retrieve data from Elasticsearch and save it as a YAML file."""
        intents_data = self.retrieve_intents_from_elastic()
        self.save_yaml(intents_data, file_path)
        print(f"Data from Elasticsearch saved to YAML file at {file_path}")

# Example Usage:

# Initialize the IntentManager
intent_manager = IntentManager(es_host="localhost", es_port=9200)

# Load YAML from file and store it in Elasticsearch
intents_from_yaml = intent_manager.load_yaml("intents.yml")
intent_manager.store_intent_to_elastic(intents_from_yaml)

# Retrieve all intents from Elasticsearch and save them back to a YAML file
intent_manager.convert_elastic_to_yaml("output_intents.yml")
